import os
import cv2
import numpy as np
from osgeo import gdal
from pyrsgis import raster
from typing import Tuple
import numpy
import torch
import torchvision.transforms as transforms
from PIL import Image
from torch import Tensor
from torch.utils.data import Dataset
from torchvision import datasets
from torchvision.datasets import ImageFolder
import utils

__all__ = ["BaseDataset_wth_folders"]




class BaseDataset_wth_folders(Dataset):
    def __init__(self, dataroot: str, mode, channels, img_size, dataset_name) -> None:
        super(BaseDataset_wth_folders, self).__init__()
        self.dataset_name = dataset_name
        if dataset_name == 'lombardia':
            self.filenames = [os.path.join(dataroot, x) for x in os.listdir(dataroot)]
            self.max=21527
        self.img_size=img_size
        self.channels = channels
        if dataset_name == 'rosetta':
            self.filenames = [os.path.join(dataroot, x) for x in os.listdir(dataroot)]
            self.max_channels = torch.FloatTensor([24.918306350708008, 4.949679374694824, 10.296469688415527, 5.303869724273682, 10.680344581604004, 5.784704208374023, 5.238860130310059, 17.55440902709961, 8.961525917053223, 13.039234161376953, 18.01114845275879, 8.95875358581543, 5.186858177185059, 9.41829776763916, 17.9587459564209, 21.48871421813965, 27.472448348999023, 14.352381706237793, 21.951108932495117, 36.60824966430664, 39.71369171142578, 34.5158805847168, 26.35395622253418, 16.807632446289062, 23.283493041992188, 15.063263893127441, 37.12959671020508, 29.39952850341797, 61.10032653808594, 79.94515991210938, 66.9842300415039, 44.059600830078125, 84.29130554199219, 66.05979919433594, 60.664306640625, 69.24669647216797, 170.0859375, 63.46596145629883, 42.47231674194336, 58.58345031738281, 62.42811584472656, 53.86623001098633, 118.63258361816406, 83.92566680908203, 75.2599868774414, 108.56890869140625, 150.91787719726562, 38.35961151123047, 125.0920639038086, 82.81085205078125, 152.96377563476562, 132.02967834472656, 58.659114837646484, 375.2607116699219, 273.491455078125, 269.63702392578125, 157.63629150390625, 133.73220825195312, 84.82666015625, 100.78582000732422, 169.0357666015625, 189.5755157470703, 61.57206344604492, 106.63225555419922, 183.7721710205078, 205.59353637695312, 413.7561950683594, 67.34658813476562, 74.06719207763672, 165.3729705810547, 148.38143920898438, 107.67698669433594, 79.11051940917969, 186.44691467285156, 64.51182556152344, 81.08837127685547, 86.00730895996094, 82.21034240722656, 315.0960998535156, 97.49380493164062, 104.99820709228516, 117.79462432861328, 105.83891296386719, 121.03123474121094, 53.61692810058594, 180.45436096191406, 80.64022064208984, 70.92591857910156, 73.83439636230469, 106.35057067871094, 91.32707977294922, 67.33539581298828, 74.45926666259766, 86.36197662353516, 199.70135498046875, 86.25960540771484, 93.90135192871094, 92.92801666259766, 149.87332153320312, 76.11236572265625, 63.99838638305664, 145.38815307617188, 119.19477081298828, 152.77818298339844, 281.2903747558594, 71.8228988647461, 86.1397933959961, 221.1125030517578, 66.96045684814453, 166.95933532714844, 96.92403411865234, 88.96703338623047, 91.49201965332031, 317.89251708984375, 93.7528305053711, 98.32965850830078, 103.99103546142578, 99.86726379394531, 106.34922790527344, 87.27008819580078, 46.40869140625, 65.09234619140625, 42.436370849609375, 113.58355712890625, 77.06586456298828, 133.2876434326172, 49.68632888793945, 29.472232818603516, 47.90450668334961, 118.91259765625, 79.00602722167969, 116.2539291381836, 68.19645690917969, 53.22411346435547, 91.48992919921875, 180.94960021972656, 44.647525787353516, 92.98197174072266, 90.8113784790039, 88.89659118652344, 106.7679672241211, 32.6988639831543, 31.889978408813477, 80.06990814208984, 95.5345458984375, 132.01702880859375, 46.3272590637207, 84.73723602294922, 27.54090118408203, 93.2492904663086, 34.132225036621094, 49.696693420410156, 30.58893585205078, 36.12554168701172, 47.214962005615234, 49.40616989135742, 52.495338439941406, 42.04363250732422, 75.47583770751953, 142.9191436767578, 96.27726745605469, 43.446163177490234, 47.18207550048828, 42.013763427734375, 46.81513595581055, 93.09855651855469, 46.52729415893555, 49.69572067260742, 25.54547691345215, 24.424619674682617, 46.29709243774414, 111.41397857666016, 30.703025817871094, 29.894323348999023, 25.59339714050293, 22.794078826904297, 24.812055587768555, 51.99293899536133, 41.609134674072266, 37.782501220703125, 34.05250549316406, 38.65347671508789, 26.16924476623535, 42.79846954345703, 42.68359375, 37.753807067871094, 32.37271499633789, 43.20640182495117, 28.428415298461914, 51.53465270996094, 42.96739196777344, 47.201805114746094, 20.31934928894043, 25.48444366455078, 62.65383529663086, 81.44580841064453, 54.423526763916016, 22.268783569335938, 57.694000244140625, 58.379817962646484, 16.69907569885254, 22.90349578857422, 37.21814727783203, 23.89931869506836, 42.045082092285156, 13.244633674621582, 13.329825401306152, 55.29010009765625, 30.293689727783203, 46.68280029296875, 24.565977096557617, 23.794652938842773, 46.728759765625, 31.066604614257812, 21.990480422973633, 17.389034271240234, 24.091808319091797, 36.9979133605957, 24.570693969726562, 55.12181854248047, 30.16541290283203, 260.4621887207031, 31.018863677978516, 92.28240203857422, 136.67257690429688, 19.80568504333496, 26.658706665039062, 134.56607055664062, 175.58042907714844, 159.8253173828125, 48.45943832397461, 17.514244079589844, 69.79733276367188, 23.479433059692383, 23.653911590576172, 27.832361221313477, 46.98639678955078, 69.20915222167969, 15.487918853759766, 25.810352325439453, 26.777441024780273, 46.876216888427734, 27.832189559936523, 69.91742706298828, 69.55229949951172, 19.4924259185791, 27.29204559326172, 20.657094955444336, 23.23644256591797, 22.415315628051758, 67.78064727783203, 22.01425552368164, 21.51711654663086, 23.877288818359375, 26.45564079284668, 33.91246032714844, 26.73786163330078, 24.165691375732422, 158.68321228027344, 273.85992431640625, 110.89370727539062, 23.01418685913086, 29.595273971557617, 32.47932434082031, 28.481754302978516, 27.494884490966797, 26.50658416748047, 55.480323791503906, 35.471431732177734, 112.4712142944336, 43.7657585144043, 15.931310653686523, 237.71946716308594, 47.94255447387695, 42.881004333496094, 112.13957214355469, 88.94918060302734, 21.140378952026367, 42.77884292602539, 26.04671287536621, 35.320621490478516, 29.83143424987793, 108.91844177246094, 57.25953674316406, 45.50440216064453, 62.356292724609375, 60.180145263671875, 157.74046325683594, 57.4941291809082, 96.79852294921875, 91.35350799560547, 87.7556381225586, 101.26182556152344, 81.04771423339844, 233.7614288330078, 197.96409606933594, 101.95027923583984, 137.67056274414062, 172.7070770263672, 282.19049072265625, 259.3553466796875, 300.44390869140625, 282.8791198730469, 208.0924835205078, 278.0406188964844, 80.56917572021484, 117.4130859375, 204.45074462890625, 131.6083526611328, 834.4985961914062, 385.4488830566406, 109.58204650878906, 276.4330749511719, 209.99356079101562, 110.94023895263672, 116.89446258544922, 59.536102294921875, 525.2793579101562, 243.1451873779297, 1279.68310546875, 100.43917083740234, 125.4314193725586, 244.55368041992188, 105.57807922363281, 108.048095703125, 74.37559509277344, 62.62845230102539, 110.68943786621094, 145.75347900390625, 115.25361633300781, 107.80815124511719, 86.32999420166016, 98.51498413085938, 171.0312957763672, 149.53640747070312, 270.2093811035156, 51.2303352355957, 38.96492385864258, 52.39421844482422, 53.24940872192383, 65.1324234008789, 40.70466232299805, 60.05177688598633, 40.49187088012695, 27.9870548248291, 47.147430419921875, 39.79123306274414, 65.99290466308594, 173.9893341064453, 49.45431900024414, 84.50733184814453, 44.76589584350586, 49.41995620727539, 49.79960632324219, 77.21097564697266, 32.264705657958984, 30.991044998168945, 123.93557739257812, 29.089208602905273, 50.301483154296875, 25.232099533081055, 31.66086196899414, 47.77195358276367, 48.26034927368164, 52.23372268676758, 28.157806396484375, 41.89118576049805, 15.890188217163086, 27.542194366455078, 25.33586883544922, 39.826499938964844, 34.6489372253418, 454.363525390625, 63.618953704833984, 58.32592010498047, 22.77511978149414, 438.4359130859375, 56.28609085083008, 45.02437973022461, 88.53937530517578, 76.28706359863281, 171.29214477539062, 59.51261901855469, 31.84840965270996, 32.74605941772461, 43.544349670410156, 76.96996307373047, 56.80706024169922, 95.41405487060547, 56.09017562866211, 152.2675323486328, 78.8620834350586, 72.2944564819336, 64.82564544677734, 38.98332595825195, 594.4119873046875, 162.0052032470703, 77.43185424804688, 99.49360656738281, 73.14791107177734, 154.16510009765625, 183.27957153320312, 221.53610229492188, 98.83876037597656, 134.4513702392578, 153.23472595214844, 113.82816314697266, 112.45922088623047, 428.3077697753906, 985.08203125, 503.47247314453125, 189.2713165283203, 179.61105346679688, 178.36598205566406, 90.1083984375, 518.141845703125, 218.3236846923828, 206.03408813476562, 395.20037841796875, 1000.908203125, 316.434814453125, 339.759765625, 896.2369995117188, 426.5946960449219, 765.7330322265625, 216.40786743164062, 279.14117431640625, 398.2585144042969, 267.7002258300781, 575.2239379882812, 365.91046142578125, 921.076904296875])
            self.min_channels = torch.FloatTensor([-0.4800158441066742, -2.459449529647827, -0.38434889912605286, -3.0395424365997314, -0.5889121890068054, -3.075608730316162, -2.788820505142212, -4.877712249755859, -1.7560038566589355, -1.2620712518692017, -1.5301967859268188, -1.3372770547866821, -1.564974069595337, -1.9562143087387085, -9.98398494720459, -1.8840965032577515, -1.7054674625396729, -1.6559548377990723, -2.94941782951355, -3.8203036785125732, -2.7157225608825684, -18.65484619140625, -7.236175537109375, -2.388995885848999, -0.996002197265625, -2.307034730911255, -0.6543103456497192, -4.975252151489258, -3.599622964859009, -3.323676109313965, -23.264856338500977, -7.3757452964782715, -73.9958724975586, -30.511375427246094, -17.16380500793457, -41.164058685302734, -24.33652687072754, -3.2790632247924805, -8.2733793258667, -21.577720642089844, -6.415185928344727, -11.322182655334473, -51.785709381103516, -237.9543914794922, -28.14011001586914, -9.129240989685059, -16.281932830810547, -4.518643856048584, -11.879061698913574, -40.95890808105469, -49.507835388183594, -25.72816276550293, -6.737839221954346, -2.963193416595459, -11.161388397216797, -11.31364917755127, -19.150676727294922, -13.165521621704102, -11.390809059143066, -13.5699462890625, -37.19996643066406, -11.360841751098633, -3.9730703830718994, -27.585357666015625, -11.312968254089355, -20.822568893432617, -41.53317642211914, -20.615970611572266, -41.241737365722656, -41.110206604003906, -15.557914733886719, -16.50225830078125, -15.636457443237305, -56.576934814453125, -27.96026611328125, -20.079011917114258, -17.645694732666016, -28.334665298461914, -305.545166015625, -158.35826110839844, -16.377540588378906, -38.47756576538086, -10.081991195678711, -2.0638341903686523, -17.19459342956543, -293.1819763183594, -78.37077331542969, -71.01992797851562, -16.6033992767334, -7.329578876495361, -15.404156684875488, -11.392985343933105, -124.64102172851562, -46.71871566772461, -55.336395263671875, -12.048635482788086, -6.04575777053833, -13.934242248535156, -21.510379791259766, -75.783935546875, -111.47012329101562, -135.61239624023438, -30.015579223632812, -45.388465881347656, -8.47636890411377, -21.681047439575195, -27.063386917114258, -62.29722595214844, -28.294227600097656, -12.84943962097168, -6.269604682922363, -15.671065330505371, -24.38330841064453, -14.89570140838623, -34.3343391418457, -18.336950302124023, -10.717079162597656, -5.2155866622924805, -7.436489582061768, -7.4993133544921875, -17.021076202392578, -5.147502422332764, -7.319873332977295, -38.45755386352539, -25.866655349731445, -9.222480773925781, -6.01908540725708, -3.0081241130828857, -9.882359504699707, -13.017207145690918, -8.843880653381348, -7.4326910972595215, -5.332645893096924, -19.481107711791992, -11.651885032653809, -23.856897354125977, -7.709122657775879, -50.43361282348633, -65.00159454345703, -13.106328010559082, -7.324402332305908, -17.81015968322754, -131.78060913085938, -56.69013977050781, -5.378760814666748, -5.379616737365723, -4.3125200271606445, -18.07127571105957, -5.572335243225098, -26.8481502532959, -12.052379608154297, -11.147034645080566, -10.738203048706055, -7.339359283447266, -19.722230911254883, -36.266700744628906, -12.174065589904785, -7.181303024291992, -13.83222484588623, -15.904854774475098, -7.500351428985596, -9.48815631866455, -10.038561820983887, -9.055488586425781, -9.634711265563965, -7.812246799468994, -12.235068321228027, -21.734344482421875, -11.95196533203125, -5.027312278747559, -3.683460235595703, -6.880013465881348, -5.163761138916016, -14.668622970581055, -20.064607620239258, -1.5894207954406738, -18.90987205505371, -19.433374404907227, -6.977980136871338, -7.166403293609619, -17.916112899780273, -15.532305717468262, -16.900114059448242, -16.988801956176758, -15.653943061828613, -2.4271457195281982, -9.53523063659668, -3.9726905822753906, -2.975898027420044, -3.1859066486358643, -4.17573356628418, -2.9085617065429688, -9.671182632446289, -18.247543334960938, -16.604034423828125, -21.253690719604492, -17.34703254699707, -18.091373443603516, -2.713529348373413, -6.238831996917725, -3.6888580322265625, -1.380781888961792, -2.1570022106170654, -1.7627440690994263, -1.5468320846557617, -2.4139063358306885, -11.05021858215332, -2.521183490753174, -5.238563537597656, -2.388575315475464, -0.9956241846084595, -4.265475273132324, -95.16883087158203, -94.60318756103516, -93.95254516601562, -77.69580841064453, -20.398195266723633, -3.877706527709961, -3.3748414516448975, -4.262847423553467, -5.950428009033203, -33.3902587890625, -2.532043933868408, -2.8827648162841797, -1.6709693670272827, -4.003675937652588, -3.840965509414673, -2.5070009231567383, -3.916841745376587, -2.5706136226654053, -5.299086570739746, -13.758284568786621, -2.1234960556030273, -7.335182189941406, -2.0991623401641846, -7.185695171356201, -2.708362340927124, -3.8228163719177246, -2.2999351024627686, -12.156732559204102, -4.619856357574463, -3.768190622329712, -9.298001289367676, -8.98756217956543, -4.426791191101074, -5.027570724487305, -3.6215097904205322, -2.4132745265960693, -8.896401405334473, -4.23172664642334, -13.446135520935059, -5.446115970611572, -22.745567321777344, -23.952016830444336, -1.7687973976135254, -10.446359634399414, -2.9945385456085205, -3.0441882610321045, -7.745938301086426, -19.928537368774414, -3.2818942070007324, -1.9499956369400024, -1.9284751415252686, -18.76059913635254, -23.098539352416992, -2.6716294288635254, -7.302299976348877, -4.636900901794434, -2.924476385116577, -3.306014060974121, -3.556302309036255, -3.8446738719940186, -31.90105438232422, -7.65613317489624, -3.9495198726654053, -4.678459644317627, -6.834418296813965, -14.43242359161377, -8.508522987365723, -8.411945343017578, -8.827934265136719, -4.8625264167785645, -5.370754718780518, -11.211642265319824, -5.329208850860596, -18.43950843811035, -15.189325332641602, -25.037687301635742, -11.25677490234375, -6.598146438598633, -8.886787414550781, -112.67022705078125, -52.659061431884766, -11.218461990356445, -7.718781471252441, -15.102899551391602, -8.130337715148926, -11.826092720031738, -10.470619201660156, -8.145949363708496, -38.46475601196289, -10.53978157043457, -11.251753807067871, -51.447147369384766, -28.08767318725586, -39.818145751953125, -7.613229751586914, -10.091509819030762, -22.991235733032227, -134.25790405273438, -16.40087127685547, -29.44106101989746, -65.07587432861328, -141.257568359375, -14.882372856140137, -81.84622955322266, -28.938823699951172, -68.42894744873047, -19.925216674804688, -39.95369338989258, -31.744735717773438, -175.29852294921875, -45.62959289550781, -56.39927673339844, -51.74333572387695, -37.774497985839844, -10.818729400634766, -13.179755210876465, -9.99958324432373, -33.37425231933594, -19.86216926574707, -8.266685485839844, -6.0833210945129395, -15.127628326416016, -43.787052154541016, -14.742793083190918, -12.782743453979492, -7.535686492919922, -8.836407661437988, -5.800745487213135, -14.9584379196167, -3.798576593399048, -7.517817497253418, -13.820169448852539, -4.804464340209961, -33.28322982788086, -5.5919718742370605, -9.24700927734375, -10.079618453979492, -20.64590072631836, -17.456819534301758, -47.5860481262207, -50.09286880493164, -37.053340911865234, -8.355339050292969, -24.853160858154297, -17.485321044921875, -26.8228759765625, -16.941524505615234, -5.883812427520752, -2.755331516265869, -9.587084770202637, -5.364669322967529, -6.92827844619751, -18.741138458251953, -19.026411056518555, -4.952157020568848, -4.9883131980896, -11.534845352172852, -11.622811317443848, -5.763716697692871, -6.240739345550537, -8.258810997009277, -4.07706880569458, -57.88644027709961, -6.820489883422852, -8.629325866699219, -6.265007495880127, -10.934640884399414, -29.07135581970215, -3.5614545345306396, -8.109285354614258, -43.86261749267578, -11.162907600402832, -9.75597095489502, -11.362030029296875, -8.387718200683594, -4.976564407348633, -25.528287887573242, -49.640323638916016, -10.402754783630371, -7.621323585510254, -11.901691436767578, -14.515600204467773, -41.57491683959961, -18.423799514770508, -61.65865707397461, -11.141708374023438, -9.93102741241455, -132.3094940185547, -119.23590087890625, -45.98780059814453, -38.457698822021484, -28.535432815551758, -14.948810577392578, -8.800559043884277, -7.953840732574463, -17.611736297607422, -30.1914119720459, -28.818300247192383, -26.76677131652832, -69.24009704589844, -71.88691711425781, -33.2972412109375, -11.361652374267578, -17.33951187133789, -13.390015602111816, -203.46897888183594, -38.79151153564453, -19.395217895507812, -260.7940673828125, -55.09280014038086, -74.52238464355469, -118.60529327392578, -24.014667510986328, -19.481653213500977, -27.823795318603516, -58.0435791015625, -290.7710876464844, -161.5175018310547, -65.40631866455078, -150.04141235351562])
            self.max_channels_repeated=self.max_channels.repeat_interleave(img_size*img_size).reshape(-1, img_size, img_size)
            self.min_channels_repeated=self.min_channels.repeat_interleave(img_size*img_size).reshape(-1, img_size, img_size)


    def __getitem__(self, index):
            if self.dataset_name == 'lombardia':
                x = gdal.Open(self.filenames[index])
                example_array = x.GetRasterBand(3).ReadAsArray()
                example_array=numpy.dstack((example_array, x.GetRasterBand(2).ReadAsArray()))
                example_array=numpy.dstack((example_array, x.GetRasterBand(1).ReadAsArray()))
                for i in range(4, self.channels+1):
                     example_array = numpy.dstack((example_array, x.GetRasterBand(i).ReadAsArray()))
                example_array = example_array.transpose(2,0,1)
                x = torch.FloatTensor(example_array)


            elif self.dataset_name == 'rosetta':
                x = gdal.Open(self.filenames[index])
                example_array=x.ReadAsArray()
                x = torch.FloatTensor(example_array)

            # profile = x.profile
            # tr=list(profile['transform'])
            # compress=profile['compress']
            # interleave=profile['interleave']
            # driver=profile['driver']FloatTensor

            if self.dataset_name == 'rosetta': x = (x - self.min_channels_repeated) / (self.max_channels_repeated - self.min_channels_repeated)
            elif self.dataset_name =='lombardia': x = x/self.max

            #only for jpeg 8bit comparison
            # x=torch.round(x*255)
            # x=x.type(torch.uint8)
            # x = (x - torch.min(x)) / (255 - torch.min(x))

            #x = self.x_transform(example_array)
            #x = torch.div(x, self.max)
            #x=x.unsqueeze(0)

            return x,  self.filenames[index].split('/')[-1]

    def __len__(self) -> int:
        return len(self.filenames)






